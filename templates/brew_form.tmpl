{{define "content"}}
<script src="/static/js/entity-manager.js?v=0.3.0"></script>
<script src="/static/js/dropdown-manager.js?v=0.3.0"></script>
<script src="/static/js/brew-form.js?v=0.3.0"></script>

<div class="max-w-2xl mx-auto" x-data="brewForm" x-init="init">
  <div class="card card-inner">
    <!-- Header with Back Button -->
    <!-- TODO: this back button implementation is probably bad -->
    <div class="flex items-center gap-3 mb-6">
      <button
        data-back-button
        data-fallback="/brews"
        class="inline-flex items-center text-brown-700 hover:text-brown-900 font-medium transition-colors cursor-pointer">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
      </button>
      <h2 class="text-3xl font-bold text-brown-900">
        {{if .Brew}}Edit Brew{{else}}New Brew{{end}}
      </h2>
    </div>

    <form 
      {{if .Brew}}
      hx-put="/brews/{{.Brew.RKey}}"
      {{else}}
      hx-post="/brews"
      {{end}}
      hx-target="body"
      class="space-y-6"
      {{if and .Brew .Brew.Pours}}
      data-pours='{{.Brew.PoursJSON}}'
      {{end}}
      x-init="init()">

      <!-- Bean Selection -->
      <div>
        <label class="form-label">Coffee Bean</label>
        <div class="flex gap-2">
          <select 
            name="bean_rkey" 
            required
            class="flex-1 form-select">
            <option value="">Select a bean...</option>
            {{if .Beans}}
            {{range .Beans}}
            <option 
              value="{{.RKey}}"
              {{if and $.Brew (eq $.Brew.BeanRKey .RKey)}}selected{{end}}
              class="truncate">
              {{if .Name}}{{.Name}} ({{.Origin}} - {{.RoastLevel}}){{else}}{{.Origin}} - {{.RoastLevel}}{{end}}
            </option>
            {{end}}
            {{else if .Brew}}
            <!-- Edit mode without server data - put selected value for JS to preserve -->
            <option value="{{.Brew.BeanRKey}}" selected>Loading...</option>
            {{end}}
          </select>
          <button 
            type="button"
            @click="showBeanForm = true; editingBean = null; beanForm = {name: '', origin: '', roast_level: '', process: '', description: '', roaster_rkey: ''}"
            class="btn-secondary">
            + New
          </button>
        </div>
      </div>

      <!-- Coffee Amount -->
      <div>
        <label class="form-label">Coffee Amount (grams)</label>
        <input 
          type="number" 
          name="coffee_amount" 
          step="0.1"
          {{if and .Brew (gt .Brew.CoffeeAmount 0)}}value="{{.Brew.CoffeeAmount}}"{{end}}
          placeholder="e.g. 18"
          class="w-full form-input-lg"/>
        <p class="text-helper">Amount of ground coffee used</p>
      </div>

      <!-- Grinder -->
      <div>
        <label class="form-label">Grinder</label>
        <div class="flex gap-2">
          <select 
            name="grinder_rkey"
            class="flex-1 form-select">
            <option value="">Select a grinder...</option>
            {{if .Grinders}}
            {{range .Grinders}}
            <option 
              value="{{.RKey}}"
              {{if and $.Brew (eq $.Brew.GrinderRKey .RKey)}}selected{{end}}
              class="truncate">
              {{.Name}}
            </option>
            {{end}}
            {{else if and .Brew .Brew.GrinderRKey}}
            <!-- Edit mode without server data - put selected value for JS to preserve -->
            <option value="{{.Brew.GrinderRKey}}" selected>Loading...</option>
            {{end}}
          </select>
          <button 
            type="button"
            @click="showGrinderForm = true; editingGrinder = null; grinderForm = {name: '', grinder_type: '', burr_type: '', notes: ''}"
            class="btn-secondary">
            + New
          </button>
        </div>
      </div>

      <!-- Grind Size -->
      <div>
        <label class="form-label">Grind Size</label>
        <input 
          type="text" 
          name="grind_size" 
          {{if .Brew}}value="{{.Brew.GrindSize}}"{{end}}
          placeholder="e.g. 18, Medium, 3.5, Fine"
          class="w-full form-input-lg"/>
        <p class="text-helper">Enter a number (grinder setting) or description (e.g. "Medium", "Fine")</p>
      </div>

      <!-- Brew Method -->
      <div>
        <label class="form-label">Brew Method</label>
        <div class="flex gap-2">
          <select 
            name="brewer_rkey"
            class="flex-1 form-select">
            <option value="">Select brew method...</option>
            {{if .Brewers}}
            {{range .Brewers}}
            <option 
              value="{{.RKey}}"
              {{if and $.Brew (eq $.Brew.BrewerRKey .RKey)}}selected{{end}}
              class="truncate">
              {{.Name}}
            </option>
            {{end}}
            {{else if and .Brew .Brew.BrewerRKey}}
            <!-- Edit mode without server data - put selected value for JS to preserve -->
            <option value="{{.Brew.BrewerRKey}}" selected>Loading...</option>
            {{end}}
          </select>
          <button 
            type="button"
            @click="showBrewerForm = true; editingBrewer = null; brewerForm = {name: '', brewer_type: '', description: ''}"
            class="btn-secondary">
            + New
          </button>
        </div>
      </div>

      <!-- Water Amount -->
      <div>
        <label class="form-label">Water Amount (grams)</label>
        <input 
          type="number" 
          name="water_amount" 
          step="1"
          {{if and .Brew (gt .Brew.WaterAmount 0)}}value="{{.Brew.WaterAmount}}"{{end}}
          placeholder="e.g. 250"
          class="w-full form-input-lg"/>
        <p class="text-helper">Total water used (or leave empty if using pours below)</p>
      </div>

      <!-- Pours Section -->
      <div>
        <div class="flex items-center justify-between mb-2">
          <label class="block text-sm font-medium text-brown-900">Pours (Optional)</label>
          <button 
            type="button"
            @click="addPour()"
            class="text-sm btn-secondary">
            + Add Pour
          </button>
        </div>
        <p class="text-sm text-brown-700 mb-3">Track individual pours for bloom and subsequent additions</p>

        <div class="space-y-3">
          <template x-for="(pour, index) in pours" :key="index">
            <div class="flex gap-2 items-center bg-brown-50 p-3 rounded-lg border border-brown-200">
              <div class="flex-1">
                <label class="text-xs text-brown-700 font-medium" x-text="'Pour ' + (index + 1)"></label>
                <input 
                  type="number"
                  :name="'pour_water_' + index"
                  x-model="pour.water"
                  placeholder="Water (g)"
                  class="w-full rounded-md border-brown-300 text-sm py-2 px-3 mt-1 bg-white"/>
              </div>
              <div class="flex-1">
                <label class="text-xs text-brown-700 font-medium">Time (sec)</label>
                <input 
                  type="number"
                  :name="'pour_time_' + index"
                  x-model="pour.time"
                  placeholder="e.g. 45"
                  class="w-full rounded-md border-brown-300 text-sm py-2 px-3 mt-1 bg-white"/>
              </div>
              <button 
                type="button"
                @click="removePour(index)"
                class="text-brown-700 hover:text-brown-900 mt-5 font-bold"
                x-show="pours.length > 0">
                âœ•
              </button>
            </div>
          </template>
        </div>
      </div>

      <!-- Temperature -->
      <div>
        <label class="form-label">Temperature</label>
        <input 
          type="number" 
          name="temperature" 
          step="0.1"
          {{if and .Brew (gt .Brew.Temperature 0.0)}}value="{{printf "%.1f" .Brew.Temperature}}"{{end}}
          placeholder="e.g. 93.5"
          class="w-full form-input-lg"/>
      </div>

      <!-- Brew Time -->
      <div>
        <label class="form-label">Brew Time (seconds)</label>
        <input 
          type="number" 
          name="time_seconds" 
          {{if and .Brew (gt .Brew.TimeSeconds 0)}}value="{{.Brew.TimeSeconds}}"{{end}}
          placeholder="e.g. 180"
          class="w-full form-input-lg"/>
      </div>

      <!-- Tasting Notes -->
      <div>
        <label class="form-label">Tasting Notes</label>
        <textarea 
          name="tasting_notes" 
          rows="4"
          placeholder="Describe the flavors, aroma, and your thoughts..."
          class="w-full form-input-lg">{{if .Brew}}{{.Brew.TastingNotes}}{{end}}</textarea>
      </div>

      <!-- Rating -->
      <div>
        <label class="form-label">Rating</label>
        <input 
          type="range" 
          name="rating" 
          min="1" 
          max="10" 
          {{if .Brew}}value="{{.Brew.Rating}}"{{else}}value="5"{{end}}
          x-model="rating"
          x-init="rating = $el.value"
          class="w-full accent-brown-700"/>
        <div class="text-center text-2xl font-bold text-brown-800">
          <span x-text="rating"></span>/10
        </div>
      </div>

      <!-- Submit -->
      <div>
        <button 
          type="submit"
          class="w-full btn-primary py-3 px-6 rounded-xl font-semibold text-lg shadow-lg hover:shadow-xl">
          {{if .Brew}}Update Brew{{else}}Save Brew{{end}}
        </button>
      </div>
    </form>
  </div>

  <!-- Modals (outside form but within Alpine scope) -->
  {{template "bean_form_modal" .}}
  {{template "grinder_form_modal" .}}
  {{template "brewer_form_modal" .}}
</div>
{{end}}
