<script>
  import { onMount } from 'svelte';
  import { authStore } from '../stores/auth.js';
  import { cacheStore } from '../stores/cache.js';
  import { navigate } from '../lib/router.js';
  import { api } from '../lib/api.js';
  import Modal from '../components/Modal.svelte';
  
  let activeTab = 'beans'; // beans, roasters, grinders, brewers
  let loading = true;
  
  // Modal states
  let showBeanModal = false;
  let showRoasterModal = false;
  let showGrinderModal = false;
  let showBrewerModal = false;
  
  // Edit states
  let editingBean = null;
  let editingRoaster = null;
  let editingGrinder = null;
  let editingBrewer = null;
  
  // Forms
  let beanForm = { name: '', origin: '', roast_level: '', process: '', description: '', roaster_rkey: '' };
  let roasterForm = { name: '', location: '', website: '', description: '' };
  let grinderForm = { name: '', grinder_type: '', burr_type: '', notes: '' };
  let brewerForm = { name: '', brewer_type: '', description: '' };
  
  $: beans = $cacheStore.beans || [];
  $: roasters = $cacheStore.roasters || [];
  $: grinders = $cacheStore.grinders || [];
  $: brewers = $cacheStore.brewers || [];
  $: isAuthenticated = $authStore.isAuthenticated;
  
  onMount(async () => {
    if (!isAuthenticated) {
      navigate('/login');
      return;
    }
    
    // Load active tab from localStorage
    const savedTab = localStorage.getItem('arabica_manage_tab');
    if (savedTab) {
      activeTab = savedTab;
    }
    
    await cacheStore.load();
    loading = false;
  });
  
  function setTab(tab) {
    activeTab = tab;
    localStorage.setItem('arabica_manage_tab', tab);
  }
  
  // Bean handlers
  function addBean() {
    editingBean = null;
    beanForm = { name: '', origin: '', roast_level: '', process: '', description: '', roaster_rkey: '' };
    showBeanModal = true;
  }
  
  function editBean(bean) {
    editingBean = bean;
    beanForm = {
      name: bean.Name || '',
      origin: bean.Origin || '',
      roast_level: bean.RoastLevel || '',
      process: bean.Process || '',
      description: bean.Description || '',
      roaster_rkey: bean.RoasterRKey || '',
    };
    showBeanModal = true;
  }
  
  async function saveBean() {
    try {
      if (editingBean) {
        await api.put(`/api/beans/${editingBean.RKey}`, beanForm);
      } else {
        await api.post('/api/beans', beanForm);
      }
      await cacheStore.invalidate();
      showBeanModal = false;
    } catch (err) {
      alert('Failed to save bean: ' + err.message);
    }
  }
  
  async function deleteBean(rkey) {
    if (!confirm('Are you sure you want to delete this bean?')) return;
    try {
      await api.delete(`/api/beans/${rkey}`);
      await cacheStore.invalidate();
    } catch (err) {
      alert('Failed to delete bean: ' + err.message);
    }
  }
  
  // Roaster handlers
  function addRoaster() {
    editingRoaster = null;
    roasterForm = { name: '', location: '', website: '', description: '' };
    showRoasterModal = true;
  }
  
  function editRoaster(roaster) {
    editingRoaster = roaster;
    roasterForm = {
      name: roaster.Name || '',
      location: roaster.Location || '',
      website: roaster.Website || '',
      description: roaster.Description || '',
    };
    showRoasterModal = true;
  }
  
  async function saveRoaster() {
    try {
      if (editingRoaster) {
        await api.put(`/api/roasters/${editingRoaster.RKey}`, roasterForm);
      } else {
        await api.post('/api/roasters', roasterForm);
      }
      await cacheStore.invalidate();
      showRoasterModal = false;
    } catch (err) {
      alert('Failed to save roaster: ' + err.message);
    }
  }
  
  async function deleteRoaster(rkey) {
    if (!confirm('Are you sure you want to delete this roaster?')) return;
    try {
      await api.delete(`/api/roasters/${rkey}`);
      await cacheStore.invalidate();
    } catch (err) {
      alert('Failed to delete roaster: ' + err.message);
    }
  }
  
  // Grinder handlers
  function addGrinder() {
    editingGrinder = null;
    grinderForm = { name: '', grinder_type: '', burr_type: '', notes: '' };
    showGrinderModal = true;
  }
  
  function editGrinder(grinder) {
    editingGrinder = grinder;
    grinderForm = {
      name: grinder.Name || '',
      grinder_type: grinder.Type || '',
      burr_type: grinder.BurrType || '',
      notes: grinder.Notes || '',
    };
    showGrinderModal = true;
  }
  
  async function saveGrinder() {
    try {
      if (editingGrinder) {
        await api.put(`/api/grinders/${editingGrinder.RKey}`, grinderForm);
      } else {
        await api.post('/api/grinders', grinderForm);
      }
      await cacheStore.invalidate();
      showGrinderModal = false;
    } catch (err) {
      alert('Failed to save grinder: ' + err.message);
    }
  }
  
  async function deleteGrinder(rkey) {
    if (!confirm('Are you sure you want to delete this grinder?')) return;
    try {
      await api.delete(`/api/grinders/${rkey}`);
      await cacheStore.invalidate();
    } catch (err) {
      alert('Failed to delete grinder: ' + err.message);
    }
  }
  
  // Brewer handlers
  function addBrewer() {
    editingBrewer = null;
    brewerForm = { name: '', brewer_type: '', description: '' };
    showBrewerModal = true;
  }
  
  function editBrewer(brewer) {
    editingBrewer = brewer;
    brewerForm = {
      name: brewer.Name || '',
      brewer_type: brewer.Type || '',
      description: brewer.Description || '',
    };
    showBrewerModal = true;
  }
  
  async function saveBrewer() {
    try {
      if (editingBrewer) {
        await api.put(`/api/brewers/${editingBrewer.RKey}`, brewerForm);
      } else {
        await api.post('/api/brewers', brewerForm);
      }
      await cacheStore.invalidate();
      showBrewerModal = false;
    } catch (err) {
      alert('Failed to save brewer: ' + err.message);
    }
  }
  
  async function deleteBrewer(rkey) {
    if (!confirm('Are you sure you want to delete this brewer?')) return;
    try {
      await api.delete(`/api/brewers/${rkey}`);
      await cacheStore.invalidate();
    } catch (err) {
      alert('Failed to delete brewer: ' + err.message);
    }
  }
</script>

<svelte:head>
  <title>Manage - Arabica</title>
</svelte:head>

<div class="max-w-6xl mx-auto">
  <h1 class="text-3xl font-bold text-brown-900 mb-6">Manage Equipment & Beans</h1>
  
  {#if loading}
    <div class="text-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brown-800 mx-auto"></div>
      <p class="mt-4 text-brown-700">Loading...</p>
    </div>
  {:else}
    <!-- Tab Navigation -->
    <div class="bg-gradient-to-br from-brown-100 to-brown-200 rounded-xl shadow-xl border border-brown-300 mb-6">
      <div class="flex border-b border-brown-300">
        <button
          on:click={() => setTab('beans')}
          class="flex-1 px-6 py-4 text-center font-medium transition-colors {activeTab === 'beans' ? 'bg-brown-50 text-brown-900 border-b-2 border-brown-700' : 'text-brown-700 hover:bg-brown-50'}"
        >
          ‚òï Beans
        </button>
        <button
          on:click={() => setTab('roasters')}
          class="flex-1 px-6 py-4 text-center font-medium transition-colors {activeTab === 'roasters' ? 'bg-brown-50 text-brown-900 border-b-2 border-brown-700' : 'text-brown-700 hover:bg-brown-50'}"
        >
          üè≠ Roasters
        </button>
        <button
          on:click={() => setTab('grinders')}
          class="flex-1 px-6 py-4 text-center font-medium transition-colors {activeTab === 'grinders' ? 'bg-brown-50 text-brown-900 border-b-2 border-brown-700' : 'text-brown-700 hover:bg-brown-50'}"
        >
          ‚öôÔ∏è Grinders
        </button>
        <button
          on:click={() => setTab('brewers')}
          class="flex-1 px-6 py-4 text-center font-medium transition-colors {activeTab === 'brewers' ? 'bg-brown-50 text-brown-900 border-b-2 border-brown-700' : 'text-brown-700 hover:bg-brown-50'}"
        >
          ü´ñ Brewers
        </button>
      </div>
      
      <!-- Tab Content -->
      <div class="p-6">
        {#if activeTab === 'beans'}
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-brown-900">Coffee Beans</h2>
            <button
              on:click={addBean}
              class="bg-brown-700 text-white px-4 py-2 rounded-lg hover:bg-brown-800 font-medium"
            >
              + Add Bean
            </button>
          </div>
          
          {#if beans.length === 0}
            <p class="text-brown-600 text-center py-8">No beans yet. Add your first bean!</p>
          {:else}
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-brown-300">
                <thead class="bg-brown-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-brown-900 uppercase">Name</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-brown-900 uppercase">Origin</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-brown-900 uppercase">Roast</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-brown-900 uppercase">Roaster</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-brown-900 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-brown-200">
                  {#each beans as bean}
                    <tr class="hover:bg-brown-50">
                      <td class="px-4 py-3 text-sm text-brown-900">{bean.Name || '-'}</td>
                      <td class="px-4 py-3 text-sm text-brown-900">{bean.Origin}</td>
                      <td class="px-4 py-3 text-sm text-brown-900">{bean.RoastLevel}</td>
                      <td class="px-4 py-3 text-sm text-brown-900">{bean.Roaster?.Name || '-'}</td>
                      <td class="px-4 py-3 text-sm space-x-2">
                        <button
                          on:click={() => editBean(bean)}
                          class="text-brown-700 hover:text-brown-900 font-medium"
                        >
                          Edit
                        </button>
                        <button
                          on:click={() => deleteBean(bean.RKey)}
                          class="text-red-600 hover:text-red-800 font-medium"
                        >
                          Delete
                        </button>
                      </td>
                    </tr>
                  {/each}
                </tbody>
              </table>
            </div>
          {/if}
        {:else if activeTab === 'roasters'}
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-brown-900">Roasters</h2>
            <button
              on:click={addRoaster}
              class="bg-brown-700 text-white px-4 py-2 rounded-lg hover:bg-brown-800 font-medium"
            >
              + Add Roaster
            </button>
          </div>
          
          {#if roasters.length === 0}
            <p class="text-brown-600 text-center py-8">No roasters yet. Add your first roaster!</p>
          {:else}
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-brown-300">
                <thead class="bg-brown-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-brown-900 uppercase">Name</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-brown-900 uppercase">Location</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-brown-900 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-brown-200">
                  {#each roasters as roaster}
                    <tr class="hover:bg-brown-50">
                      <td class="px-4 py-3 text-sm text-brown-900">{roaster.Name}</td>
                      <td class="px-4 py-3 text-sm text-brown-900">{roaster.Location || '-'}</td>
                      <td class="px-4 py-3 text-sm space-x-2">
                        <button
                          on:click={() => editRoaster(roaster)}
                          class="text-brown-700 hover:text-brown-900 font-medium"
                        >
                          Edit
                        </button>
                        <button
                          on:click={() => deleteRoaster(roaster.RKey)}
                          class="text-red-600 hover:text-red-800 font-medium"
                        >
                          Delete
                        </button>
                      </td>
                    </tr>
                  {/each}
                </tbody>
              </table>
            </div>
          {/if}
        {:else if activeTab === 'grinders'}
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-brown-900">Grinders</h2>
            <button
              on:click={addGrinder}
              class="bg-brown-700 text-white px-4 py-2 rounded-lg hover:bg-brown-800 font-medium"
            >
              + Add Grinder
            </button>
          </div>
          
          {#if grinders.length === 0}
            <p class="text-brown-600 text-center py-8">No grinders yet. Add your first grinder!</p>
          {:else}
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-brown-300">
                <thead class="bg-brown-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-brown-900 uppercase">Name</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-brown-900 uppercase">Type</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-brown-900 uppercase">Burr Type</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-brown-900 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-brown-200">
                  {#each grinders as grinder}
                    <tr class="hover:bg-brown-50">
                      <td class="px-4 py-3 text-sm text-brown-900">{grinder.Name}</td>
                      <td class="px-4 py-3 text-sm text-brown-900">{grinder.Type || '-'}</td>
                      <td class="px-4 py-3 text-sm text-brown-900">{grinder.BurrType || '-'}</td>
                      <td class="px-4 py-3 text-sm space-x-2">
                        <button
                          on:click={() => editGrinder(grinder)}
                          class="text-brown-700 hover:text-brown-900 font-medium"
                        >
                          Edit
                        </button>
                        <button
                          on:click={() => deleteGrinder(grinder.RKey)}
                          class="text-red-600 hover:text-red-800 font-medium"
                        >
                          Delete
                        </button>
                      </td>
                    </tr>
                  {/each}
                </tbody>
              </table>
            </div>
          {/if}
        {:else if activeTab === 'brewers'}
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-brown-900">Brewers</h2>
            <button
              on:click={addBrewer}
              class="bg-brown-700 text-white px-4 py-2 rounded-lg hover:bg-brown-800 font-medium"
            >
              + Add Brewer
            </button>
          </div>
          
          {#if brewers.length === 0}
            <p class="text-brown-600 text-center py-8">No brewers yet. Add your first brewer!</p>
          {:else}
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-brown-300">
                <thead class="bg-brown-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-brown-900 uppercase">Name</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-brown-900 uppercase">Type</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-brown-900 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-brown-200">
                  {#each brewers as brewer}
                    <tr class="hover:bg-brown-50">
                      <td class="px-4 py-3 text-sm text-brown-900">{brewer.Name}</td>
                      <td class="px-4 py-3 text-sm text-brown-900">{brewer.Type || '-'}</td>
                      <td class="px-4 py-3 text-sm space-x-2">
                        <button
                          on:click={() => editBrewer(brewer)}
                          class="text-brown-700 hover:text-brown-900 font-medium"
                        >
                          Edit
                        </button>
                        <button
                          on:click={() => deleteBrewer(brewer.RKey)}
                          class="text-red-600 hover:text-red-800 font-medium"
                        >
                          Delete
                        </button>
                      </td>
                    </tr>
                  {/each}
                </tbody>
              </table>
            </div>
          {/if}
        {/if}
      </div>
    </div>
  {/if}
</div>

<!-- Modals -->
<Modal
  bind:isOpen={showBeanModal}
  title={editingBean ? 'Edit Bean' : 'Add Bean'}
  onSave={saveBean}
  onCancel={() => showBeanModal = false}
>
  <div class="space-y-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
      <input type="text" bind:value={beanForm.name} class="w-full rounded border-gray-300 px-3 py-2" />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Origin *</label>
      <input type="text" bind:value={beanForm.origin} required class="w-full rounded border-gray-300 px-3 py-2" />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Roast Level *</label>
      <select bind:value={beanForm.roast_level} required class="w-full rounded border-gray-300 px-3 py-2">
        <option value="">Select...</option>
        <option value="Light">Light</option>
        <option value="Medium-Light">Medium-Light</option>
        <option value="Medium">Medium</option>
        <option value="Medium-Dark">Medium-Dark</option>
        <option value="Dark">Dark</option>
      </select>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Process</label>
      <input type="text" bind:value={beanForm.process} class="w-full rounded border-gray-300 px-3 py-2" />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Roaster</label>
      <select bind:value={beanForm.roaster_rkey} class="w-full rounded border-gray-300 px-3 py-2">
        <option value="">Select...</option>
        {#each roasters as roaster}
          <option value={roaster.RKey}>{roaster.Name}</option>
        {/each}
      </select>
    </div>
  </div>
</Modal>

<Modal
  bind:isOpen={showRoasterModal}
  title={editingRoaster ? 'Edit Roaster' : 'Add Roaster'}
  onSave={saveRoaster}
  onCancel={() => showRoasterModal = false}
>
  <div class="space-y-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
      <input type="text" bind:value={roasterForm.name} required class="w-full rounded border-gray-300 px-3 py-2" />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
      <input type="text" bind:value={roasterForm.location} class="w-full rounded border-gray-300 px-3 py-2" />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Website</label>
      <input type="url" bind:value={roasterForm.website} class="w-full rounded border-gray-300 px-3 py-2" />
    </div>
  </div>
</Modal>

<Modal
  bind:isOpen={showGrinderModal}
  title={editingGrinder ? 'Edit Grinder' : 'Add Grinder'}
  onSave={saveGrinder}
  onCancel={() => showGrinderModal = false}
>
  <div class="space-y-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
      <input type="text" bind:value={grinderForm.name} required class="w-full rounded border-gray-300 px-3 py-2" />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
      <select bind:value={grinderForm.grinder_type} class="w-full rounded border-gray-300 px-3 py-2">
        <option value="">Select...</option>
        <option value="Manual">Manual</option>
        <option value="Electric">Electric</option>
        <option value="Blade">Blade</option>
      </select>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Burr Type</label>
      <select bind:value={grinderForm.burr_type} class="w-full rounded border-gray-300 px-3 py-2">
        <option value="">Select...</option>
        <option value="Flat">Flat</option>
        <option value="Conical">Conical</option>
      </select>
    </div>
  </div>
</Modal>

<Modal
  bind:isOpen={showBrewerModal}
  title={editingBrewer ? 'Edit Brewer' : 'Add Brewer'}
  onSave={saveBrewer}
  onCancel={() => showBrewerModal = false}
>
  <div class="space-y-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
      <input type="text" bind:value={brewerForm.name} required class="w-full rounded border-gray-300 px-3 py-2" />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
      <select bind:value={brewerForm.brewer_type} class="w-full rounded border-gray-300 px-3 py-2">
        <option value="">Select...</option>
        <option value="Pour Over">Pour Over</option>
        <option value="French Press">French Press</option>
        <option value="Espresso">Espresso</option>
        <option value="Moka Pot">Moka Pot</option>
        <option value="Aeropress">Aeropress</option>
        <option value="Cold Brew">Cold Brew</option>
        <option value="Siphon">Siphon</option>
      </select>
    </div>
  </div>
</Modal>
