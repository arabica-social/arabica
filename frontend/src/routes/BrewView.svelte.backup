<script>
  import { onMount } from 'svelte';
  import { authStore } from '../stores/auth.js';
  import { cacheStore } from '../stores/cache.js';
  import { navigate } from '../lib/router.js';
  import { api } from '../lib/api.js';
  
  export let id; // RKey from route
  
  let brew = null;
  let loading = true;
  let error = null;
  let isOwnProfile = false;
  
  $: isAuthenticated = $authStore.isAuthenticated;
  
  onMount(async () => {
    if (!isAuthenticated) {
      navigate('/login');
      return;
    }
    
    // Load from cache first
    await cacheStore.load();
    const brews = $cacheStore.brews || [];
    brew = brews.find(b => b.RKey === id);
    loading = false;
    isOwnProfile = true; // Currently viewing own profile
  });
  
  async function deleteBrew() {
    if (!confirm('Are you sure you want to delete this brew?')) {
      return;
    }
    
    try {
      await api.delete(`/brews/${id}`);
      await cacheStore.invalidate();
      navigate('/brews');
    } catch (err) {
      alert('Failed to delete brew: ' + err.message);
    }
  }
  
  function hasValue(val) {
    return val !== null && val !== undefined && val !== '';
  }
  
  function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit'
    });
  }
</script>

<svelte:head>
  <title>Brew Details - Arabica</title>
</svelte:head>

<div class="max-w-2xl mx-auto">
  {#if loading}
    <div class="text-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brown-800 mx-auto"></div>
      <p class="mt-4 text-brown-700">Loading brew...</p>
    </div>
  {:else if !brew}
    <div class="bg-gradient-to-br from-brown-100 to-brown-200 rounded-xl p-12 text-center border border-brown-300">
      <h2 class="text-2xl font-bold text-brown-900 mb-2">Brew Not Found</h2>
      <p class="text-brown-700 mb-6">The brew you're looking for doesn't exist.</p>
      <button
        on:click={() => navigate('/brews')}
        class="bg-gradient-to-r from-brown-700 to-brown-800 text-white px-6 py-3 rounded-lg hover:from-brown-800 hover:to-brown-900 transition-all font-semibold shadow-lg"
      >
        Back to Brews
      </button>
    </div>
  {:else}
    <div class="bg-gradient-to-br from-brown-100 to-brown-200 rounded-xl shadow-xl p-8 border border-brown-300">
      <!-- Header with title and actions -->
      <div class="flex justify-between items-start mb-6">
        <div>
          <h2 class="text-3xl font-bold text-brown-900">Brew Details</h2>
          <p class="text-sm text-brown-600 mt-1">{formatDate(brew.CreatedAt)}</p>
        </div>
        {#if isOwnProfile}
          <div class="flex gap-2">
            <button
              on:click={() => navigate(`/brews/${brew.RKey}/edit`)}
              class="inline-flex items-center bg-brown-300 text-brown-900 px-4 py-2 rounded-lg hover:bg-brown-400 font-medium transition-colors"
            >
              Edit
            </button>
            <button
              on:click={deleteBrew}
              class="inline-flex items-center bg-brown-200 text-brown-700 px-4 py-2 rounded-lg hover:bg-brown-300 font-medium transition-colors"
            >
              Delete
            </button>
          </div>
        {/if}
      </div>

      <div class="space-y-6">
        <!-- Rating (prominent at top) -->
        {#if hasValue(brew.Rating)}
          <div class="text-center py-4 bg-brown-50 rounded-lg border border-brown-200">
            <div class="text-4xl font-bold text-brown-800">
              {brew.Rating}/10
            </div>
            <div class="text-sm text-brown-600 mt-1">Rating</div>
          </div>
        {/if}

        <!-- Coffee Bean -->
        <div class="bg-brown-50 rounded-lg p-4 border border-brown-200">
          <h3 class="text-sm font-medium text-brown-600 uppercase tracking-wider mb-2">Coffee Bean</h3>
          {#if brew.Bean}
            <div class="font-bold text-lg text-brown-900">
              {brew.Bean.Name || brew.Bean.Origin}
            </div>
            {#if brew.Bean.Roaster?.Name}
              <div class="text-sm text-brown-700 mt-1">
                by {brew.Bean.Roaster.Name}
              </div>
            {/if}
            <div class="flex flex-wrap gap-3 mt-2 text-sm text-brown-600">
              {#if brew.Bean.Origin}<span>Origin: {brew.Bean.Origin}</span>{/if}
              {#if brew.Bean.RoastLevel}<span>Roast: {brew.Bean.RoastLevel}</span>{/if}
            </div>
          {:else}
            <span class="text-brown-400">Not specified</span>
          {/if}
        </div>

        <!-- Brew Parameters -->
        <div class="grid grid-cols-2 gap-4">
          <!-- Brew Method -->
          <div class="bg-brown-50 rounded-lg p-4 border border-brown-200">
            <h3 class="text-sm font-medium text-brown-600 uppercase tracking-wider mb-2">Brew Method</h3>
            {#if brew.BrewerObj}
              <div class="font-semibold text-brown-900">{brew.BrewerObj.Name}</div>
            {:else if brew.Method}
              <div class="font-semibold text-brown-900">{brew.Method}</div>
            {:else}
              <span class="text-brown-400">Not specified</span>
            {/if}
          </div>

          <!-- Grinder -->
          <div class="bg-brown-50 rounded-lg p-4 border border-brown-200">
            <h3 class="text-sm font-medium text-brown-600 uppercase tracking-wider mb-2">Grinder</h3>
            {#if brew.GrinderObj}
              <div class="font-semibold text-brown-900">{brew.GrinderObj.Name}</div>
            {:else}
              <span class="text-brown-400">Not specified</span>
            {/if}
          </div>

          <!-- Coffee Amount -->
          <div class="bg-brown-50 rounded-lg p-4 border border-brown-200">
            <h3 class="text-sm font-medium text-brown-600 uppercase tracking-wider mb-2">Coffee</h3>
            {#if hasValue(brew.CoffeeAmount)}
              <div class="font-semibold text-brown-900">{brew.CoffeeAmount}g</div>
            {:else}
              <span class="text-brown-400">Not specified</span>
            {/if}
          </div>

          <!-- Water Amount -->
          <div class="bg-brown-50 rounded-lg p-4 border border-brown-200">
            <h3 class="text-sm font-medium text-brown-600 uppercase tracking-wider mb-2">Water</h3>
            {#if hasValue(brew.WaterAmount)}
              <div class="font-semibold text-brown-900">{brew.WaterAmount}g</div>
            {:else}
              <span class="text-brown-400">Not specified</span>
            {/if}
          </div>

          <!-- Grind Size -->
          <div class="bg-brown-50 rounded-lg p-4 border border-brown-200">
            <h3 class="text-sm font-medium text-brown-600 uppercase tracking-wider mb-2">Grind Size</h3>
            {#if brew.GrindSize}
              <div class="font-semibold text-brown-900">{brew.GrindSize}</div>
            {:else}
              <span class="text-brown-400">Not specified</span>
            {/if}
          </div>

          <!-- Water Temperature -->
          <div class="bg-brown-50 rounded-lg p-4 border border-brown-200">
            <h3 class="text-sm font-medium text-brown-600 uppercase tracking-wider mb-2">Water Temp</h3>
            {#if hasValue(brew.WaterTemp)}
              <div class="font-semibold text-brown-900">{brew.WaterTemp}°C</div>
            {:else}
              <span class="text-brown-400">Not specified</span>
            {/if}
          </div>
        </div>

        <!-- Pours (if any) -->
        {#if brew.Pours && brew.Pours.length > 0}
          <div class="bg-brown-50 rounded-lg p-4 border border-brown-200">
            <h3 class="text-sm font-medium text-brown-600 uppercase tracking-wider mb-3">Pour Schedule</h3>
            <div class="space-y-2">
              {#each brew.Pours as pour, i}
                <div class="flex justify-between text-sm">
                  <span class="text-brown-700">Pour {i + 1}:</span>
                  <span class="font-semibold text-brown-900">{pour.Water}g at {pour.Time}s</span>
                </div>
              {/each}
            </div>
          </div>
        {/if}

        <!-- Tasting Notes -->
        {#if brew.Notes}
          <div class="bg-brown-50 rounded-lg p-4 border border-brown-200">
            <h3 class="text-sm font-medium text-brown-600 uppercase tracking-wider mb-2">Tasting Notes</h3>
            <p class="text-brown-900 italic">"{brew.Notes}"</p>
          </div>
        {/if}
      </div>

      <!-- Back button -->
      <div class="mt-6">
        <button
          on:click={() => navigate('/brews')}
          class="text-brown-700 hover:text-brown-900 font-medium hover:underline"
        >
          ← Back to Brews
        </button>
      </div>
    </div>
  {/if}
</div>
